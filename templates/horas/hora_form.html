{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Horas Múltiples - Sistema de Gestión de Horas{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
}
.registro-item {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f8f9fa;
}
.progress-horas {
    height: 8px;
    margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Registrar Múltiples Horas
                    </h5>
                </div>
                
                <div class="card-body">
                    {% csrf_token %}
                    
                    <!-- Selector de Fecha -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="fecha_trabajo" class="form-label">Fecha de Trabajo</label>
                            <input type="date" id="fecha_trabajo" class="form-control" max="{{ today }}">
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted">Registradas:</small>
                                            <strong id="horas-registradas">0.0</strong>h
                                        </div>
                                        <div>
                                            <small class="text-muted">Disponibles:</small>
                                            <strong id="horas-disponibles">{{ limite_diario|default:"8.0" }}</strong>h
                                        </div>
                                    </div>
                                    <div class="progress progress-horas">
                                        <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Registros Existentes -->
                    <div id="registros-existentes" class="mb-4" style="display: none;">
                        <h6>Registros Existentes</h6>
                        <div id="lista-existentes" class="list-group"></div>
                    </div>
                    
                    <!-- Nuevos Registros -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Nuevos Registros</h6>
                            <button type="button" id="agregar-registro" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-1"></i>Agregar Registro
                            </button>
                        </div>
                        
                        <div id="registros-activos"></div>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'horas:hora_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Volver
                        </a>
                        <div>
                            <a href="{% url 'horas:hora_create' %}" class="btn btn-outline-info me-2">
                                <i class="fas fa-plus me-1"></i>Registro Simple
                            </a>
                            <button type="button" id="guardar-registros" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Guardar Todos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let registroCounter = 0;
    let limiteDiario = parseFloat('{{ limite_diario|default:"8.0" }}'.replace(',', '.')) || 8.0;
    let horasRegistradas = 0.0;
    
    const fechaInput = document.getElementById('fecha_trabajo');
    const registrosContainer = document.getElementById('registros-activos');
    const agregarBtn = document.getElementById('agregar-registro');
    const guardarBtn = document.getElementById('guardar-registros');
    
    // Inicializar fecha
    const urlParams = new URLSearchParams(window.location.search);
    const fechaParam = urlParams.get('fecha');
    if (fechaParam) {
        fechaInput.value = fechaParam;
    } else {
        fechaInput.value = '{{ today }}';
    }
    
    function initSelect2(selectElement) {
        if (!selectElement || selectElement.classList.contains('select2-hidden-accessible')) return;
        
        $(selectElement).select2({
            placeholder: 'Buscar proyecto...',
            allowClear: false,
            width: '100%',
            templateResult: function(option) {
                if (!option.id) return option.text;
                
                const text = option.text;
                const parts = text.split(' - ');
                if (parts.length >= 2) {
                    const nombre = parts[0];
                    const cliente = parts.slice(1).join(' - ');
                    
                    return $(`
                        <div>
                            <div style="font-weight: bold;">${nombre}</div>
                            <small style="color: #6c757d;">${cliente}</small>
                        </div>
                    `);
                }
                
                return $(`<div>${text}</div>`);
            }
        });
    }
    
    async function cargarDatosDia() {
        const fecha = fechaInput.value;
        if (!fecha) return;
        
        try {
            const response = await fetch(`/horas/api/fecha/${fecha}/`);
            const data = await response.json();
            
            horasRegistradas = data.reduce((total, registro) => total + parseFloat(registro.horas), 0);
            mostrarRegistrosExistentes(data);
            actualizarLimiteDiario();
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            document.getElementById('registros-existentes').style.display = 'none';
        }
    }
    
    function mostrarRegistrosExistentes(registros) {
        const container = document.getElementById('registros-existentes');
        const lista = document.getElementById('lista-existentes');
        
        if (registros.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        lista.innerHTML = '';
        registros.forEach(registro => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${registro.proyecto}</strong>
                    <small class="text-muted d-block">${registro.descripcion}</small>
                </div>
                <span class="badge bg-primary">${registro.horas}h</span>
            `;
            lista.appendChild(item);
        });
        
        container.style.display = 'block';
    }
    
    function actualizarLimiteDiario() {
        const disponible = limiteDiario - horasRegistradas;
        const porcentaje = (horasRegistradas / limiteDiario) * 100;
        
        document.getElementById('horas-registradas').textContent = horasRegistradas.toFixed(1);
        document.getElementById('horas-disponibles').textContent = disponible.toFixed(1);
        document.getElementById('progress-bar').style.width = `${Math.min(porcentaje, 100)}%`;
        
        const progressBar = document.getElementById('progress-bar');
        if (porcentaje >= 100) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (porcentaje >= 80) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
        
        agregarBtn.disabled = disponible <= 0;
    }
    
    function crearRegistro() {
        registroCounter++;
        
        const nuevoRegistro = document.createElement('div');
        nuevoRegistro.className = 'registro-item';
        nuevoRegistro.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Registro #${registroCounter}</h6>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-success agregar-registro-inline me-2">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger eliminar-registro">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Proyecto</label>
                    <select class="form-select proyecto-select" name="proyecto" required>
                        <option value="">Seleccionar proyecto...</option>
                        {% for proyecto in proyectos %}
                        <option value="{{ proyecto.id }}">{{ proyecto.nombre }} - {{ proyecto.cliente }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Horas</label>
                    <input type="number" class="form-control horas-input" name="horas" 
                           min="0.5" max="12" step="0.5" required>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" name="tipo_tarea" required>
                        <option value="tarea">Tarea</option>
                        <option value="reunion">Reunión</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-2">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" name="descripcion" rows="2" required></textarea>
            </div>
        `;
        
        registrosContainer.appendChild(nuevoRegistro);
        
        // Inicializar Select2 para el nuevo selector
        const proyectoSelect = nuevoRegistro.querySelector('.proyecto-select');
        setTimeout(() => initSelect2(proyectoSelect), 100);
        
        // Event listeners
        nuevoRegistro.querySelector('.eliminar-registro').addEventListener('click', () => {
            nuevoRegistro.remove();
            actualizarTotalTemporal();
        });
        
        nuevoRegistro.querySelector('.agregar-registro-inline').addEventListener('click', () => {
            agregarRegistro();
        });
        
        nuevoRegistro.querySelector('.horas-input').addEventListener('input', actualizarTotalTemporal);
    }
    
    function actualizarTotalTemporal() {
        let totalNuevo = 0;
        document.querySelectorAll('.horas-input').forEach(input => {
            const valor = parseFloat(input.value) || 0;
            totalNuevo += valor;
        });
        
        const totalConExistentes = horasRegistradas + totalNuevo;
        const disponible = limiteDiario - totalConExistentes;
        const porcentaje = (totalConExistentes / limiteDiario) * 100;
        
        document.getElementById('progress-bar').style.width = `${Math.min(porcentaje, 100)}%`;
        document.getElementById('horas-disponibles').textContent = disponible.toFixed(1);
        
        const progressBar = document.getElementById('progress-bar');
        if (porcentaje >= 100) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (porcentaje >= 80) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
        
        agregarBtn.disabled = disponible <= 0;
    }
    
    async function guardarRegistros() {
        const fecha = fechaInput.value;
        if (!fecha) {
            alert('Selecciona una fecha');
            return;
        }
        
        const registros = [];
        document.querySelectorAll('.registro-item').forEach(item => {
            const proyecto = item.querySelector('[name="proyecto"]').value;
            const horas = item.querySelector('[name="horas"]').value;
            const tipo = item.querySelector('[name="tipo_tarea"]').value;
            const descripcion = item.querySelector('[name="descripcion"]').value;
            
            if (proyecto && horas && descripcion) {
                registros.push({ proyecto, horas, tipo_tarea: tipo, descripcion });
            }
        });
        
        if (registros.length === 0) {
            alert('Agrega al menos un registro');
            return;
        }
        
        try {
            guardarBtn.disabled = true;
            guardarBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
            
            for (const registro of registros) {
                const formData = new FormData();
                formData.append('fecha', fecha);
                formData.append('proyecto', registro.proyecto);
                formData.append('horas', registro.horas);
                formData.append('tipo_tarea', registro.tipo_tarea);
                formData.append('descripcion', registro.descripcion);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch('/horas/registrar/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Error al guardar registro: ${response.status}`);
                }
            }
            
            alert('Registros guardados exitosamente');
            window.location.href = '/horas/';
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar los registros');
        } finally {
            guardarBtn.disabled = false;
            guardarBtn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Todos';
        }
    }
    
    // Event Listeners
    fechaInput.addEventListener('change', cargarDatosDia);
    agregarBtn.addEventListener('click', crearRegistro);
    guardarBtn.addEventListener('click', guardarRegistros);
    
    // Agregar primer registro automáticamente
    crearRegistro();
    
    // Inicializar
    cargarDatosDia();
});
</script>
{% endblock %}
