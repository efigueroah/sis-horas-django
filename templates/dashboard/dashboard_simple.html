{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Sistema de Gestión de Horas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Dashboard</h1>
            
            {% if not periodo_activo %}
            <div class="alert alert-warning">
                <strong>Atención:</strong> No hay un período activo configurado. 
                <a href="{% url 'core:periodo_list' %}" class="alert-link">Configure un período</a> para ver información completa.
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Horas</h5>
                    <h2 class="text-primary">{{ total_horas|default:0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Objetivo</h5>
                    <h2 class="text-info">{{ horas_objetivo|default:0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Completación</h5>
                    <h2 class="text-success">{{ porcentaje_completacion|floatformat:1 }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Días Trabajados</h5>
                    <h2 class="text-warning">{{ dias_trabajados|default:0 }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendario -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Calendario de Horas</h5>
                    {% if periodo_activo %}
                    <small class="text-muted">
                        Período activo: {{ periodo_activo.nombre }} 
                        (Límite diario: {{ periodo_activo.horas_max_dia }}h)
                    </small>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="calendario-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando calendario...</p>
                        </div>
                    </div>
                    
                    <!-- Leyenda -->
                    <div class="mt-3">
                        <small class="text-muted">
                            <span class="badge bg-success me-2">Completo ({{ periodo_activo.horas_max_dia|default:"8" }}+ horas)</span>
                            <span class="badge bg-warning me-2">Parcial (&lt;{{ periodo_activo.horas_max_dia|default:"8" }} horas)</span>
                            <span class="badge bg-danger me-2">Sin horas</span>
                            <span class="badge bg-secondary me-2">Fin de semana</span>
                            <span class="badge bg-info me-2">Feriado</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando dashboard simple...');
    cargarCalendario();
});

async function cargarCalendario() {
    try {
        const container = document.getElementById('calendario-container');
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        
        const response = await fetch(`/api/calendario/${year}/${month}/`);
        const data = await response.json();
        
        if (data.success) {
            mostrarCalendario(data.calendario, year, month);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Error: ' + (data.error || 'No se pudo cargar el calendario') + '</div>';
        }
    } catch (error) {
        console.error('Error cargando calendario:', error);
        document.getElementById('calendario-container').innerHTML = 
            '<div class="alert alert-danger">Error al cargar el calendario</div>';
    }
}

function mostrarCalendario(calendario, year, month) {
    const limiteDiario = {% if periodo_activo %}{{ periodo_activo.horas_max_dia }}{% else %}8{% endif %};
    const container = document.getElementById('calendario-container');
    
    let html = '<table class="table table-bordered">';
    html += '<thead><tr><th>Dom</th><th>Lun</th><th>Mar</th><th>Mié</th><th>Jue</th><th>Vie</th><th>Sáb</th></tr></thead>';
    html += '<tbody>';
    
    calendario.forEach(semana => {
        html += '<tr>';
        semana.forEach(dia => {
            if (dia === null) {
                html += '<td></td>';
            } else {
                let clase = 'text-center p-2';
                let color = '';
                
                if (dia.es_fin_semana) {
                    color = 'background-color: #f8f9fa; color: #6c757d;';
                } else if (dia.es_feriado) {
                    color = 'background-color: #d1ecf1; color: #0c5460;';
                } else if (dia.horas >= limiteDiario) {
                    color = 'background-color: #d4edda; color: #155724;';
                } else if (dia.horas > 0) {
                    color = 'background-color: #fff3cd; color: #856404;';
                } else {
                    color = 'background-color: #f8d7da; color: #721c24;';
                }
                
                html += `<td class="${clase}" style="${color}">`;
                html += `<div><strong>${dia.dia}</strong></div>`;
                if (dia.horas > 0) {
                    html += `<small>${dia.horas}h</small>`;
                }
                html += '</td>';
            }
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}
</script>
{% endblock %}
