{% extends 'base.html' %}
{% load static %}

{% block title %}Exportar Reportes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-download text-success me-2"></i>
                        Exportar Reportes de Horas
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" id="exportForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-filter me-2"></i>
                                            Filtros de Exportación
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="fecha_inicio" class="form-label">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Fecha de Inicio
                                            </label>
                                            <input type="date" class="form-control" id="fecha_inicio" 
                                                   name="fecha_inicio" value="{{ form.fecha_inicio.value|default:'' }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="fecha_fin" class="form-label">
                                                <i class="fas fa-calendar-check me-1"></i>
                                                Fecha de Fin
                                            </label>
                                            <input type="date" class="form-control" id="fecha_fin" 
                                                   name="fecha_fin" value="{{ form.fecha_fin.value|default:'' }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="periodo" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>
                                                Período
                                            </label>
                                            <select class="form-select" id="periodo" name="periodo">
                                                <option value="">Todos los períodos</option>
                                                {% for periodo in periodos %}
                                                <option value="{{ periodo.pk }}" 
                                                        {% if form.periodo.value == periodo.pk %}selected{% endif %}>
                                                    {{ periodo.nombre }}
                                                    {% if periodo.activo %}
                                                        <span class="badge bg-success">Activo</span>
                                                    {% endif %}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="proyectos" class="form-label">
                                                <i class="fas fa-project-diagram me-1"></i>
                                                Proyectos
                                            </label>
                                            <select class="form-select" id="proyectos" name="proyectos" multiple size="5">
                                                {% for proyecto in proyectos %}
                                                <option value="{{ proyecto.pk }}"
                                                        {% if proyecto.pk in form.proyectos.value %}selected{% endif %}
                                                        style="color: {{ proyecto.color_hex }};">
                                                    {{ proyecto.nombre }}
                                                    {% if proyecto.cliente %}({{ proyecto.cliente }}){% endif %}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="form-text">
                                                Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples proyectos.
                                                Deja vacío para incluir todos los proyectos.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-cog me-2"></i>
                                            Opciones de Exportación
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="formato" class="form-label">
                                                <i class="fas fa-file-export me-1"></i>
                                                Formato de Archivo
                                            </label>
                                            <select class="form-select" id="formato" name="formato">
                                                <option value="csv" {% if form.formato.value == 'csv' or config and config.formato_exportacion == 'csv' %}selected{% endif %}>
                                                    <i class="fas fa-file-csv"></i> CSV (Comma Separated Values)
                                                </option>
                                                <option value="xlsx" {% if form.formato.value == 'xlsx' or config and config.formato_exportacion == 'xlsx' %}selected{% endif %}>
                                                    <i class="fas fa-file-excel"></i> Excel (XLSX)
                                                </option>
                                                <option value="pdf" {% if form.formato.value == 'pdf' or config and config.formato_exportacion == 'pdf' %}selected{% endif %}>
                                                    <i class="fas fa-file-pdf"></i> PDF
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3" id="csv-options">
                                            <label for="separador" class="form-label">
                                                <i class="fas fa-grip-lines-vertical me-1"></i>
                                                Separador CSV
                                            </label>
                                            <select class="form-select" id="separador" name="separador">
                                                <option value="," {% if form.separador.value == ',' or config and config.separador_csv == ',' %}selected{% endif %}>
                                                    Coma (,)
                                                </option>
                                                <option value=";" {% if form.separador.value == ';' or config and config.separador_csv == ';' %}selected{% endif %}>
                                                    Punto y coma (;)
                                                </option>
                                                <option value="|" {% if form.separador.value == '|' or config and config.separador_csv == '|' %}selected{% endif %}>
                                                    Pipe (|)
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="incluir_totales" name="incluir_totales"
                                                       {% if form.incluir_totales.value %}checked{% endif %}>
                                                <label class="form-check-label" for="incluir_totales">
                                                    <i class="fas fa-calculator me-1"></i>
                                                    Incluir totales por proyecto
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="agrupar_por_fecha" name="agrupar_por_fecha"
                                                       {% if form.agrupar_por_fecha.value %}checked{% endif %}>
                                                <label class="form-check-label" for="agrupar_por_fecha">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    Agrupar por fecha
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="incluir_descripcion" name="incluir_descripcion"
                                                       {% if form.incluir_descripcion.value %}checked{% endif %}>
                                                <label class="form-check-label" for="incluir_descripcion">
                                                    <i class="fas fa-file-alt me-1"></i>
                                                    Incluir descripciones
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-eye me-2"></i>
                                            Vista Previa de Datos
                                        </h5>
                                        <button type="button" class="btn btn-light btn-sm" id="previewBtn">
                                            <i class="fas fa-sync me-1"></i>
                                            Actualizar Vista Previa
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="preview-content">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-search fa-2x mb-2"></i>
                                                <p>Haga clic en "Actualizar Vista Previa" para ver los datos que se exportarán</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'reportes:reporte_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver a Reportes
                                    </a>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" id="saveConfigBtn">
                                            <i class="fas fa-save me-1"></i>
                                            Guardar Configuración
                                        </button>
                                        <button type="submit" class="btn btn-success" id="exportBtn">
                                            <i class="fas fa-download me-1"></i>
                                            Exportar Reporte
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h5>Generando reporte...</h5>
                <p class="text-muted mb-0">Por favor espere mientras se procesa su solicitud</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formatoSelect = document.getElementById('formato');
    const csvOptions = document.getElementById('csv-options');
    const previewBtn = document.getElementById('previewBtn');
    const exportBtn = document.getElementById('exportBtn');
    const exportForm = document.getElementById('exportForm');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    // Show/hide CSV options based on format
    function toggleCSVOptions() {
        if (formatoSelect.value === 'csv') {
            csvOptions.style.display = 'block';
        } else {
            csvOptions.style.display = 'none';
        }
    }
    
    formatoSelect.addEventListener('change', toggleCSVOptions);
    toggleCSVOptions(); // Initial call
    
    // Set default dates (current month)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    if (!document.getElementById('fecha_inicio').value) {
        document.getElementById('fecha_inicio').value = firstDay.toISOString().split('T')[0];
    }
    if (!document.getElementById('fecha_fin').value) {
        document.getElementById('fecha_fin').value = lastDay.toISOString().split('T')[0];
    }
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        const formData = new FormData(exportForm);
        formData.append('preview', 'true');
        
        previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cargando...';
        previewBtn.disabled = true;
        
        fetch('{% url "reportes:exportar" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            const previewContent = document.getElementById('preview-content');
            if (data.success) {
                previewContent.innerHTML = data.preview_html;
            } else {
                previewContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || 'No se encontraron datos para los filtros seleccionados'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('preview-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar la vista previa
                </div>
            `;
        })
        .finally(() => {
            previewBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Actualizar Vista Previa';
            previewBtn.disabled = false;
        });
    });
    
    // Export form submission
    exportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate date range
        const fechaInicio = document.getElementById('fecha_inicio').value;
        const fechaFin = document.getElementById('fecha_fin').value;
        
        if (fechaInicio && fechaFin && fechaInicio > fechaFin) {
            alert('La fecha de inicio no puede ser posterior a la fecha de fin');
            return;
        }
        
        // Show loading modal
        loadingModal.show();
        
        // Crear formulario temporal para envío directo
        const tempForm = document.createElement('form');
        tempForm.method = 'POST';
        tempForm.action = '{% url "reportes:exportar" %}';
        tempForm.style.display = 'none';
        
        // Copiar todos los campos
        const formData = new FormData(exportForm);
        for (let [key, value] of formData.entries()) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            tempForm.appendChild(input);
        }
        
        document.body.appendChild(tempForm);
        tempForm.submit();
        document.body.removeChild(tempForm);
        
        // Cerrar modal después de un breve delay
        setTimeout(() => {
            loadingModal.hide();
            
            // Mostrar mensaje de éxito
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Reporte exportado exitosamente
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.row'));
        }, 2000);
    });
    
    // Auto-update preview when filters change
    const filterInputs = document.querySelectorAll('#fecha_inicio, #fecha_fin, #periodo, #proyectos');
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Clear preview
            document.getElementById('preview-content').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>Los filtros han cambiado. Actualice la vista previa para ver los nuevos datos.</p>
                </div>
            `;
        });
    });
});
</script>
{% endblock %}
